
# Empirical Results

```{r setup, include = FALSE}
source("misc/load_libraries.R")
knitr::opts_chunk$set(include = FALSE, echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r load data}
data <- read_rds("data/final/data.RDS")
```

```{r function to extract coefficients}
# because I'm only running log-linear regressions, I set it to return a string
# with a percentage rounded to 2 decimal places
extract_coef <- function(model, var) {
    coefs <- coef(model)
    result <- (coefs[var] * 100) %>% as.double() %>% round(2) %>% as.character()
    return(str_c(result, "%"))
}
```

```{r set up models}
make_reg_formula <- function(...) {
    input_list <- list(...)
    result <- ""
    for (v in input_list) {
        for (ele in v) {
            result <- str_c(result, ele, sep = " + ")
        }
    }
    result <- str_sub(result, 4, str_length(result)) # remove additional " + " at the front
    return(result)
}
reg <- function(..., area_fe = "", time_fe = "") {
    reg_formula <- make_reg_formula(...)
    if (time_fe != "") {
        reg_formula <- str_c(reg_formula, " + ", time_fe)
    }
    if (area_fe != "") {
        reg_formula <- str_c(reg_formula, " | ", area_fe)
    }
    felm(formula(reg_formula), data = data, subset = f_eval(subs, data))
}
summary2 <- function(reg_mdl) {
    summ <- summary(reg_mdl)
    summ$coefficients <- summ$coefficients[!str_detect(dimnames(summ$coefficients)[[1]], time_fe),]
    return(summ)
} 
base_reg <- "ln_price ~ award_dummy"
did_dummy <- "award_after"
controls <- c("ctrl_prop_type", "ctrl_ln_area", "ctrl_freehold", "ctrl_floor")
area_fe <- "ctrl_postal_first4"
time_fe <- "sale_ym"
subs <- ~ sale_type == "New Sale" & ctrl_prop_type != "Executive Condominium"
```


```{r naive model}
naive_mdl <- reg(base_reg)
summary(naive_mdl)
```

```{r naive model with controls}
naive_mdl_with_controls <- reg(base_reg, controls, area_fe = area_fe)
summary(naive_mdl_with_controls)
```

```{r model with controls and year-month FE}
naive_mdl_with_controls_ymfe <- reg(base_reg, controls, area_fe = area_fe, time_fe = time_fe)
summary(naive_mdl_with_controls_ymfe)
```

```{r main results, include = TRUE, results = "asis"}
vars_to_keep <- c("award_dummy", "ctrl_ln_area", "ctrl_floor", "ctrl_hdb_buyer", "ctrl_prop_typeCondominium", "ctrl_prop_typeExecutive Condominium", "ctrl_freehold")
labels <- c("GM Award", "ln(Area)", "Floor", "HDB Buyer", "Property Type: Condominium", "Property Type: Executive Condominium", "Freehold")
postal_sector_fe <- c("Postal Sector Dummies", "No", "Yes", "Yes")
year_qtr_fe <- c("Year-Month Dummies", "No", "No", "Yes")
stargazer(naive_mdl, naive_mdl_with_controls, naive_mdl_with_controls_yqfe, 
          type = "latex", title = "Effects of GM Award on Price",
          keep = vars_to_keep, order = vars_to_keep, covariate.labels = labels,
          dep.var.labels = "Natural log of Price", header = FALSE,
          add.lines = list(postal_sector_fe, year_qtr_fe), label = "mainresults")
```

```{r DID base model}
did_base_mdl <- lm(
    ln_price ~ award_dummy + award_after + ctrl_ln_area + ctrl_floor + 
        ctrl_hdb_buyer + ctrl_prop_type + ctrl_freehold + ctrl_postal_sector + sale_ym, 
    data = data, subset = sale_type == "New Sale")
```


```{r DID results, include = TRUE, results = "asis"}
vars_to_keep <- c("award_dummy", "award_after", "ctrl_ln_area", "ctrl_floor", "ctrl_hdb_buyer", "ctrl_prop_typeCondominium", "ctrl_prop_typeExecutive Condominium", "ctrl_freehold")
labels <- c("GM Award", "GM x After GM (1 = Yes)", "ln(Area)", "Floor", "HDB Buyer", "Property Type: Condominium", "Property Type: Executive Condominium", "Freehold")
postal_sector_fe <- c("Postal Sector Dummies", "Yes")
year_qtr_fe <- c("Year-Month Dummies", "Yes")
stargazer(did_base_mdl, 
          type = "latex", title = "Difference-in-difference Models",
          keep = vars_to_keep, order = vars_to_keep, covariate.labels = labels,
          dep.var.labels = "Natural log of Price", header = FALSE,
          add.lines = list(postal_sector_fe, year_qtr_fe), label = "didresults")
```

```{r placebo models}
placebo_6mo_mdl <- lm(
    ln_price ~ award_dummy + placebo_after_6mo + ctrl_ln_area + ctrl_floor + 
        ctrl_hdb_buyer + ctrl_prop_type + ctrl_freehold + ctrl_postal_sector + sale_ym,
    data = data, subset = sale_type == "New Sale" & placebo_after_gm_flag == 1)
placebo_12mo_mdl <- lm(
    ln_price ~ award_dummy + placebo_after_12mo + ctrl_ln_area + ctrl_floor + 
        ctrl_hdb_buyer + ctrl_prop_type + ctrl_freehold + ctrl_postal_sector + sale_ym,
    data = data, subset = sale_type == "New Sale" & placebo_after_gm_flag == 1)
#summary(placebo_12mo_mdl)
```

```{r placebo results, include = TRUE, results = "asis"}
vars_to_keep <- c("award_dummy", "placebo_after_6mo", "placebo_after_12mo", "ctrl_ln_area", "ctrl_floor", "ctrl_hdb_buyer", "ctrl_prop_typeCondominium", "ctrl_prop_typeExecutive Condominium", "ctrl_freehold")
labels <- c("GM Award (1 = Yes)", "GM x After (6 months before GM), 1 = Yes", 
            "GM x After (12 months before GM), 1 = Yes",
            "ln(Area)", "Floor", "HDB Buyer", "Property Type: Condominium", 
            "Property Type: Executive Condominium", "Freehold")
postal_sector_fe <- c("Postal Sector Dummies", "Yes", "Yes")
year_qtr_fe <- c("Year-Month Dummies", "Yes", "Yes")
stargazer(placebo_6mo_mdl, placebo_12mo_mdl,
          type = "latex", title = "Placebo Difference-in-difference Tests",
          keep = vars_to_keep, order = vars_to_keep, covariate.labels = labels,
          dep.var.labels = "Natural log of Price", header = FALSE,
          add.lines = list(postal_sector_fe, year_qtr_fe), label = "placeboresults")
```


\newpage